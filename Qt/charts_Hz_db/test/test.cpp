#include "test.h"
#include "ui_test.h"
#include "../FFT/FFT.h"
//#include "../FFT/fft1.h"



double array_audio[N] = {
    0                         ,
    15796488.1550936          ,
    10643353.1573629          ,
    -8625212.78552242         ,
    -16454846.4989456         ,
    -2461728.86372008         ,
    14796183.5469654          ,
    12431097.0755232          ,
    -6420362.60441050         ,
    -16757007.1085727         ,
    -4870168.73178839         ,
    13475586.2484776          ,
    13949745.2830361          ,
    -4076530.96195592         ,
    -16696429.1192804         ,
    -7173184.15438004         ,
    11863283.2030314          ,
    15166423.6324193          ,
    -1644454.73501133         ,
    -16274423.8615956         ,
    -9320921.80254019         ,
    9994175.90251931          ,
    16054794.7116918          ,
    823218.970808733          ,
    -15500126.4749209         ,
    -11266889.6422027         ,
    7908724.87542493          ,
    16595627.9698053          ,
    3273072.47197409          ,
    -14390298.1593543         ,
    -12968963.3463246         ,
    5652073.83856960          ,
    16777216                  ,
    5652073.83856959          ,
    -12968963.3463246         ,
    -14390298.1593543         ,
    3273072.47197410          ,
    16595627.9698053          ,
    7908724.87542492          ,
    -11266889.6422027         ,
    -15500126.4749209         ,
    823218.970808800          ,
    16054794.7116918          ,
    9994175.90251935          ,
    -9320921.80254019         ,
    -16274423.8615956         ,
    -1644454.73501132         ,
    15166423.6324193          ,
    11863283.2030315          ,
    -7173184.15437999         ,
    -16696429.1192804         ,
    -4076530.96195591         ,
    13949745.2830361          ,
    13475586.2484776          ,
    -4870168.73178846         ,
    -16757007.1085727         ,
    -6420362.60441041         ,
    12431097.0755233          ,
    14796183.5469655          ,
    -2461728.86372000         ,
    -16454846.4989456         ,
    -8625212.78552247         ,
    10643353.1573628          ,
    15796488.1550936          ,
    -8.23923509288123e-09     ,
    -15796488.1550936         ,
    -10643353.1573628         ,
    8625212.78552248          ,
    16454846.4989455          ,
    2461728.86371999          ,
    -14796183.5469655         ,
    -12431097.0755233         ,
    6420362.60441043          ,
    16757007.1085727          ,
    4870168.73178844          ,
    -13475586.2484776         ,
    -13949745.2830361         ,
    4076530.96195593          ,
    16696429.1192804          ,
    7173184.15437998          ,
    -11863283.2030315         ,
    -15166423.6324193         ,
    1644454.73501146          ,
    16274423.8615956          ,
    9320921.80254028          ,
    -9994175.90251927         ,
    -16054794.7116918         ,
    -823218.970808784         ,
    15500126.4749209          ,
    11266889.6422027          ,
    -7908724.87542493         ,
    -16595627.9698053         ,
    -3273072.47197408         ,
    14390298.1593544          ,
    12968963.3463245          ,
    -5652073.83856972         ,
    -16777216                 ,
    -5652073.83856969         ,
    12968963.3463245          ,
    14390298.1593544          ,
    -3273072.47197411         ,
    -16595627.9698053         ,
    -7908724.87542491         ,
    11266889.6422027          ,
    15500126.4749209          ,
    -823218.970808571         ,
    -16054794.7116918         ,
    -9994175.90251944         ,
    9320921.80254030          ,
    16274423.8615956          ,
    1644454.73501119          ,
    -15166423.6324193         ,
    -11863283.2030313         ,
    7173184.15438000          ,
    16696429.1192804          ,
    4076530.96195591          ,
    -13949745.2830359         ,
    -13475586.2484776         ,
    4870168.73178824          ,
    16757007.1085727          ,
    6420362.60441063          ,
    -12431097.0755233         ,
    -14796183.5469655         ,
    2461728.86372025          ,
    16454846.4989456          ,
    8625212.78552226          ,
    -10643353.1573628         ,
    -15796488.1550935         ,
    1.64784701857625e-08      ,
    15796488.1550936          ,
    10643353.1573628          ,
    -8625212.78552228         ,
    -16454846.4989455         ,
    -2461728.86372021         ,
    14796183.5469655          ,
    12431097.0755233          ,
    -6420362.60441066         ,
    -16757007.1085727         ,
    -4870168.73178821         ,
    13475586.2484776          ,
    13949745.2830359          ,
    -4076530.96195594         ,
    -16696429.1192804         ,
    -7173184.15437997         ,
    11863283.2030313          ,
    15166423.6324193          ,
    -1644454.73501123         ,
    -16274423.8615956         ,
    -9320921.80254027         ,
    9994175.90251946          ,
    16054794.7116918          ,
    823218.970808538          ,
    -15500126.4749209         ,
    -11266889.6422025         ,
    7908724.87542494          ,
    16595627.9698053          ,
    3273072.47197408          ,
    -14390298.1593542         ,
    -12968963.3463245         ,
    5652073.83856950          ,
    16777216                  ,
    5652073.83856968          ,
    -12968963.3463247         ,
    -14390298.1593543         ,
    3273072.47197435          ,
    16595627.9698053          ,
    7908724.87542469          ,
    -11266889.6422027         ,
    -15500126.4749210         ,
    823218.970808817          ,
    16054794.7116917          ,
    9994175.90251924          ,
    -9320921.80254011         ,
    -16274423.8615955         ,
    -1644454.73501142         ,
    15166423.6324194          ,
    11863283.2030315          ,
    -7173184.15438022         ,
    -16696429.1192804         ,
    -4076530.96195567         ,
    13949745.2830361          ,
    13475586.2484777          ,
    -4870168.73178847         ,
    -16757007.1085727         ,
    -6420362.60441040         ,
    12431097.0755232          ,
    14796183.5469654          ,
    -2461728.86372002         ,
    -16454846.4989456         ,
    -8625212.78552245         ,
    10643353.1573630          ,
    15796488.1550936          ,
    2.13700873822919e-07      ,
    -15796488.1550936         ,
    -10643353.1573630         ,
    8625212.78552250          ,
    16454846.4989456          ,
    2461728.86371997          ,
    -14796183.5469654         ,
    -12431097.0755231         ,
    6420362.60441044          ,
    16757007.1085727          ,
    4870168.73178843          ,
    -13475586.2484777         ,
    -13949745.2830361         ,
    4076530.96195572          ,
    16696429.1192804          ,
    7173184.15438018          ,
    -11863283.2030315         ,
    -15166423.6324194         ,
    1644454.73501100          ,
    16274423.8615956          ,
    9320921.80254006          ,
    -9994175.90251928         ,
    -16054794.7116919         ,
    -823218.970808291         ,
    15500126.4749210          ,
    11266889.6422027          ,
    -7908724.87542474         ,
    -16595627.9698053         ,
    -3273072.47197383         ,
    14390298.1593544          ,
    12968963.3463246          ,
    -5652073.83856928         ,
    -16777216                 ,
    -5652073.83856945         ,
    12968963.3463245          ,
    14390298.1593545          ,
    -3273072.47197459         ,
    -16595627.9698053         ,
    -7908724.87542490         ,
    11266889.6422025          ,
    15500126.4749210          ,
    -823218.970809063         ,
    -16054794.7116918         ,
    -9994175.90251942         ,
    9320921.80253992          ,
    16274423.8615955          ,
    1644454.73501118          ,
    -15166423.6324193         ,
    -11863283.2030316         ,
    7173184.15438045          ,
    16696429.1192804          ,
    4076530.96195589          ,
    -13949745.2830360         ,
    -13475586.2484778         ,
    4870168.73178871          ,
    16757007.1085727          ,
    6420362.60441061          ,
    -12431097.0755230         ,
    -14796183.5469653         ,
    2461728.86372026          ,
    16454846.4989456          ,
    8625212.78552265          ,
    -10643353.1573632         ,
    -15796488.1550935         ,
    3.29569403715249e-08      ,
    15796488.1550936          ,
    10643353.1573632          ,
    -8625212.78552271         ,
    -16454846.4989455         ,
    -2461728.86372020         ,
    14796183.5469653          ,
    12431097.0755230          ,
    -6420362.60441067         ,
    -16757007.1085727         ,
    -4870168.73178865         ,
    13475586.2484779          ,
    13949745.2830359          ,
    -4076530.96195596         ,
    -16696429.1192804         ,
    -7173184.15438039         ,
    11863283.2030317          ,
    15166423.6324193          ,
    -1644454.73501124         ,
    -16274423.8615955         ,
    -9320921.80253986         ,
    9994175.90251948          ,
    16054794.7116918          ,
    823218.970808997          ,
    -15500126.4749211         ,
    -11266889.6422025         ,
    7908724.87542496          ,
    16595627.9698053          ,
    3273072.47197453          ,
    -14390298.1593545         ,
    -12968963.3463245         ,
    5652073.83856951          ,
    16777216                  ,
    5652073.83856922          ,
    -12968963.3463247         ,
    -14390298.1593543         ,
    3273072.47197390          ,
    16595627.9698054          ,
    7908724.87542468          ,
    -11266889.6422027         ,
    -15500126.4749209         ,
    823218.970808357          ,
    16054794.7116919          ,
    9994175.90251922          ,
    -9320921.80254012         ,
    -16274423.8615956         ,
    -1644454.73501093         ,
    15166423.6324194          ,
    11863283.2030315          ,
    -7173184.15437981         ,
    -16696429.1192804         ,
    -4076530.96195565         ,
    13949745.2830361          ,
    13475586.2484777          ,
    -4870168.73178803         ,
    -16757007.1085727         ,
    -6420362.60441038         ,
    12431097.0755232          ,
    14796183.5469656          ,
    -2461728.86372051         ,
    -16454846.4989456         ,
    -8625212.78552244         ,
    10643353.1573627          ,
    15796488.1550935          ,
    -2.79614754565969e-07     ,
    -15796488.1550936         ,
    -10643353.1573630         ,
    8625212.78552210          ,
    16454846.4989455          ,
    2461728.86371995          ,
    -14796183.5469654         ,
    -12431097.0755234         ,
    6420362.60441090          ,
    16757007.1085727          ,
    4870168.73178841          ,
    -13475586.2484774         ,
    -13949745.2830358         ,
    4076530.96195619          ,
    16696429.1192804          ,
    7173184.15438016          ,
    -11863283.2030312         ,
    -15166423.6324192         ,
    1644454.73501149          ,
    16274423.8615955          ,
    9320921.80254045          ,
    -9994175.90251967         ,
    -16054794.7116917         ,
    -823218.970808751         ,
    15500126.4749208          ,
    11266889.6422023          ,
    -7908724.87542517         ,
    -16595627.9698053         ,
    -3273072.47197429         ,
    14390298.1593541          ,
    12968963.3463243          ,
    -5652073.83856975         ,
    -16777216                 ,
    -5652073.83856989         ,
    12968963.3463248          ,
    14390298.1593542          ,
    -3273072.47197414         ,
    -16595627.9698053         ,
    -7908724.87542446         ,
    11266889.6422029          ,
    15500126.4749209          ,
    -823218.970808604         ,
    -16054794.7116917         ,
    -9994175.90251903         ,
    9320921.80254033          ,
    16274423.8615956          ,
    1644454.73501164          ,
    -15166423.6324195         ,
    -11863283.2030313         ,
    7173184.15438003          ,
    16696429.1192804          ,
    4076530.96195541          ,
    -13949745.2830362         ,
    -13475586.2484775         ,
    4870168.73178827          ,
    16757007.1085727          ,
    6420362.60441016          ,
    -12431097.0755233         ,
    -14796183.5469655         ,
    2461728.86371981          ,
    16454846.4989457          ,
    8625212.78552223          ,
    -10643353.1573629         ,
    -15796488.1550937         ,
    -4.27401747645838e-07     ,
    15796488.1550937          ,
    10643353.1573628          ,
    -8625212.78552231         ,
    -16454846.4989456         ,
    -2461728.86371971         ,
    14796183.5469655          ,
    12431097.0755233          ,
    -6420362.60441025         ,
    -16757007.1085727         ,
    -4870168.73178818         ,
    13475586.2484776          ,
    13949745.2830362          ,
    -4076530.96195551         ,
    -16696429.1192804         ,
    -7173184.15437994         ,
    11863283.2030314          ,
    15166423.6324195          ,
    -1644454.73501173         ,
    -16274423.8615956         ,
    -9320921.80254024         ,
    9994175.90251911          ,
    16054794.7116917          ,
    823218.970808505          ,
    -15500126.4749209         ,
    -11266889.6422028         ,
    7908724.87542455          ,
    16595627.9698052          ,
    3273072.47197404          ,
    -14390298.1593543         ,
    -12968963.3463248         ,
    5652073.83856998          ,
    16777216                  ,
    5652073.83856965          ,
    -12968963.3463244         ,
    -14390298.1593541         ,
    3273072.47197345          ,
    16595627.9698053          ,
    7908724.87542424          ,
    -11266889.6422024         ,
    -15500126.4749208         ,
    823218.970807897          ,
    16054794.7116918          ,
    9994175.90251883          ,
    -9320921.80253974         ,
    -16274423.8615955         ,
    -1644454.73501044         ,
    15166423.6324192          ,
    11863283.2030311          ,
    -7173184.15437939         ,
    -16696429.1192804         ,
    -4076530.96195517         ,
    13949745.2830358          ,
    13475586.2484774          ,
    -4870168.73178759         ,
    -16757007.1085727         ,
    -6420362.60440993         ,
    12431097.0755229          ,
    14796183.5469654          ,
    -2461728.86372099         ,
    -16454846.4989455         ,
    -8625212.78552202         ,
    10643353.1573623          ,
    15796488.1550936          ,
    -7.72930382954856e-07     ,
    -15796488.1550935         ,
    -10643353.1573626         ,
    8625212.78552171          ,
    16454846.4989456          ,
    2461728.86371947          ,
    -14796183.5469652         ,
    -12431097.0755231         ,
    6420362.60441135          ,
    16757007.1085727          ,
    4870168.73178794          ,
    -13475586.2484772         ,
    -13949745.2830360         ,
    4076530.96195667          ,
    16696429.1192804          ,
    7173184.15437972          ,
    -11863283.2030309         ,
    -15166423.6324194         ,
    1644454.73501198          ,
    16274423.8615954          ,
    9320921.80254004          ,
    -9994175.90252007         ,
    -16054794.7116919         ,
    -823218.970808258         ,
    15500126.4749206          ,
    11266889.6422026          ,
    -7908724.87542561         ,
    -16595627.9698053         ,
    -3273072.47197380         ,
    14390298.1593539          ,
    12968963.3463246          ,
    -5652073.83857021         ,
    -16777216                 ,
    -5652073.83856942         ,
    12968963.3463252          ,
    14390298.1593544          ,
    -3273072.47197462         ,
    -16595627.9698052         ,
    -7908724.87542487         ,
    11266889.6422033          ,
    15500126.4749210          ,
    -823218.970809096         ,
    -16054794.7116915         ,
    -9994175.90251940         ,
    9320921.80254073          ,
    16274423.8615957          ,
    1644454.73501115          ,
    -15166423.6324197         ,
    -11863283.2030316         ,
    7173184.15438048          ,
    16696429.1192805          ,
    4076530.96195586          ,
    -13949745.2830365         ,
    -13475586.2484778         ,
    4870168.73178874          ,
    16757007.1085727          ,
    6420362.60441058          ,
    -12431097.0755237         ,
    -14796183.5469657         ,
    2461728.86372029          ,
    16454846.4989457          ,
    8625212.78552262          ,
    -10643353.1573633         ,
    -15796488.1550938
};
test::test(QWidget *parent) :
    QWidget(parent),
    ui(new Ui::test)
{
    ui->setupUi(this);
    QCustomplot_Init(ui->widgetFFT,500,100);
    ui->widgetFFT->setVisible(true);
}

test::~test()
{
    delete ui;
}

/* 坐标系配置 */
void test::QCustomplot_Init(QCustomPlot *widget,int x_range,int y_range)
{

    //设置坐标尺寸
    widget->addGraph();
    //设置X轴、Y轴范围
    widget->xAxis->setRange(0, x_range);
    widget->yAxis->setRange(0, y_range);

    /* 设置坐标系缩放，坐标轴缩放 */
    widget->setInteractions(QCP::iRangeDrag | QCP::iRangeZoom | QCP::iSelectPlottables);
    /* 设置曲线类型 */
    widget->graph(0)->setLineStyle((QCPGraph::LineStyle)1);

}

void test::on_ButtonDisplayFFT_clicked()
{

//    ui->widgetData->setHidden(false);
//    ui->widgetFFT->setHidden(true);
//    ui->widgetData->setVisible(false);
//    ui->widgetFFT->setVisible(true);
    QVector<double> XData,YData;
    int d_size[1] = { N };
    int F_size[1] = { N };
    double THD = 0;
    double *FreqDeviation;
    double SNR = 0;
    double SPL = 0;
    FFT(array_audio, d_size, F, F_size);
    F[0] = 0;
    for(int i=0;i<LENGTH_DATA;i++)
    {
        XData.append(i);
  //      YData.append(BufferData[i]);
        YData.append(F[i]);
    }
    ui->widgetFFT->graph(0)->setName("快速傅立叶变换");
    ui->widgetFFT->graph(0)->setData(XData,YData);
    ui->widgetFFT->rescaleAxes();
    ui->widgetFFT->replot();

    FreqDeviation = GetFreqDeviation(F);
    ui->FreqEdit->setText(QString::number(FreqDeviation[0]));

    THD = GetTHD(F,FreqDeviation[1],6);
    ui->THDEdit->setText(QString::number(THD));

    ui->SNREdit->setText(QString::number(SNR));

    SPL = GetSPL(array_audio);
    ui->SPLEdit->setText(QString::number(SPL));

}

/* 总谐波失真度获取 */
double test::GetTHD(double F_data[N],int realFreq,int NumHarmonic)
{
    double n = realFreq;
    double d_Harmonic2 = 0;
    double d_base = 0;
    double THD = 0;
    for(int i = 0;i<NumHarmonic-1;i++)
    {
        if(n*(i+1)>N/2){
            break;
        }//超出对称的界限
        if(i == 0) d_base = F_data[int(n)];
        else d_Harmonic2 += F_data[int(n*(i+1))]*F_data[int(n*(i+1))];
    }
    THD = 100* (sqrt(d_Harmonic2))/d_base;
    return THD;
}

double test::GetSPL(double* data)
{
    double sum = 0;
    double pa = 0;
    double p0 = 2e-5;
    double spl = 0;
    for(int i=0;i<N;i++)
    {
        sum += data[i]*data[i];
    }
    pa = sqrt(sum/N);
    spl = 20*log10(pa/p0);
    return spl;
}

double* test::GetFreqDeviation(double F_data[N])
{
    double max = 0;
    double index = 0;
    double freq_real = 0;
    static double FreqDeviation[2] = {0};
    for(int i=0;i<N;i++)
    {
        if(F_data[i]>max)
        {
            max = F_data[i];
            index = i;
        }
        if(index > N/2) index = N - index;

    }
    freq_real = Sample*index/N;
    FreqDeviation[0] = 100*(fabs(freq_real - FreqStandard)) /freq_real;
    FreqDeviation[1] = index;
    return FreqDeviation;
}

double test::GetSNR(double data[N],double data_standard[N])
{
    double SNR = 0;



    return SNR;
}

void test::on_ButtonDisplayData_clicked()
{    

//    QVector<double> XData,YData;
//    for(int i=0;i<LENGTH_DATA;i++)
//    {
//        XData.append(i);
//  //      YData.append(BufferData[i]);
//        YData.append((array_audio[i]-2)*50);
//    }
//    ui->widgetData->graph(0)->setData(XData,YData);
//    ui->widgetData->rescaleAxes();
//    ui->widgetData->replot();

    QVector<double> XData,YData;
    for(int i=0;i<LENGTH_DATA;i++)
    {
        XData.append(i);
  //      YData.append(BufferData[i]);
        YData.append((array_audio[i]-2)*50);
    }
    ui->widgetFFT->graph(0)->setName("实时数据");
    ui->widgetFFT->graph(0)->setData(XData,YData);
    ui->widgetFFT->rescaleAxes();
    ui->widgetFFT->replot();
}



